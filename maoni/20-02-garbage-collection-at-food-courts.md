<h1>Garbage Collection at Food Courts</h1>

When I first started working on the GC, my predecessor was explaining the GC tuning to me. I told him that I thought it sounded like how I saw janitors work at food courts (I frequented food courts at the time ğŸ˜€). And he concurred.

What I said was if you observe at a food court, in order to be productive, the janitor tries to collect a sizable amount of dirty dishes when they come out to collect, which means they collect more often when itâ€™s busy to not risk running out of clean dishes, and less often when itâ€™s not busy because there are very few dishes to be collected. This is the same way that the GC tunes. The dirty dishes are like the space occupied by dead objects â€“ it was used (ie, dirtied) and can now be reclaimed. The clean dishes are like the cleared space GC hands out for people to use for new objects, ie, allocations. If GC does a collection and didnâ€™t find much dead space, meaning high survival rate, it will wait till more cleared space is used, or in other words, more allocations are made before it does the next collection.

During meal times, food courts are busy so the clean dishes are consumed more quickly, and the janitor adjusts to that. This is the same as GC adjusts the amount of allocations before the next collection. Itâ€™s called the allocation budget. And this â€œadjustingâ€ that GC does is part of its dynamic tuning. As the process runs, GC will modify this allocation budget according to the survival rate it observes to keep itself productive.

Now, the janitor needs a way to recognize if a dish is still in use â€“ it would be quite rude for the janitor to take your dish away if you are still in the middle of using it (if they do that a lot I imagine theyâ€™d be firedâ€¦). If you are still eating, thatâ€™s pretty obvious. Thatâ€™s the most common scenario. If say you need to leave temporarily (like if you suddenly remembered you needed to get a slice of cake before that dessert place closesâ€¦), you might put your jacket on the chair to indicate that you are still here. GC also needs to know if an object is still in use. The most common way is just by one object having a reference to another and thatâ€™s obvious to the GC. And there also exist other less common ways that require more effort to indicate to the GC that an object is in use, for example, the GC handles.

Over the years Iâ€™ve used this food court analogy to explain GC tuning to others and it seems to be well received, even by folks who donâ€™t work in tech fields at all. Once I was at a class about communication and each person was required to give a 1 minute speech to explain their work. Many people in that class worked in finance and sales. I used the foot court analogy and years later I still got people from the class who enthusiastically told me that they understood how a garbage collector works ğŸ˜„ thanks to the analogy, and still remembered it to that day.

The runtime team used to have what we called the â€œCLR Foundationsâ€ series where someone explains to the rest of the team the area they worked on. So when I explained the GC I used the food court analogy. Some of my coworkers told me they really enjoyed it. Of course as creative as they were, they started suggesting other things at a food court that could be used. I remember one suggested that we could use how people are seated to illustrate a compacting collector, as in, if there arenâ€™t that many people, they could be sitting sparsely at tables. But if they are running out of tables, people can sit closely together to free up space to accommodate more.

A while ago the cafeteria at work (for the building I was in) started to implement this new â€œzero wasteâ€ thing which meant we no longer throw away garbage or put dirty dishes away ourselves. Instead a cafeteria employee acts as the garbage collector. So itâ€™s like at a food court. And this garbage collector had a very aggressive collection policy. Sometime when people just finished eating and are still chatting at the table, they would already start a collection which meant each person would need to pass them their used dishes ğŸ˜› Knowing this I was very mindful with my food but one time I was still not quick enough â€“ after I put my food for a few seconds they already started collecting. I sent the cafeteria manager an email to suggested a way to indicate â€œin useâ€. As always sheâ€™s extremely nice; and apparently already had a way to indicate this and just needed to remind some of her staff of it. She also said â€œI will also make sure they understand the importance of waiting before clearing a table after the initial lunch rushâ€. And I thought, â€œhey, thatâ€™s dynamic tuning right there!â€.

https://devblogs.microsoft.com/dotnet/garbage-collection-at-food-courts/å½“æˆ‘åˆšå¼€å§‹ä»äº‹åƒåœ¾å›æ”¶ï¼ˆGCï¼‰å·¥ä½œæ—¶ï¼Œæˆ‘çš„å‰ä»»æ­£åœ¨å‘æˆ‘è§£é‡Š GC çš„è°ƒä¼˜è¿‡ç¨‹ã€‚æˆ‘å‘Šè¯‰ä»–ï¼Œæˆ‘è§‰å¾—è¿™å¬èµ·æ¥å¾ˆåƒæˆ‘å½“æ—¶åœ¨ç¾é£Ÿå¹¿åœºçœ‹åˆ°çš„æ¸…æ´å·¥çš„å·¥ä½œæ–¹å¼ï¼ˆé‚£æ—¶æˆ‘ç»å¸¸å…‰é¡¾ç¾é£Ÿå¹¿åœº ğŸ˜Šï¼‰ã€‚ä»–å¯¹æ­¤è¡¨ç¤ºèµåŒã€‚

æˆ‘è¯´çš„æ˜¯ï¼Œå¦‚æœä½ è§‚å¯Ÿä¸€ä¸‹ç¾é£Ÿå¹¿åœºï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œæ¸…æ´å·¥æ¯æ¬¡å‡ºæ¥æ”¶é›†é¤å…·æ—¶ä¼šå°½é‡æ”¶é›†å¤§é‡çš„è„ç›˜å­ã€‚è¿™æ„å‘³ç€åœ¨å¿™ç¢Œçš„æ—¶å€™ï¼Œä»–ä»¬ä¼šæ›´é¢‘ç¹åœ°æ”¶é›†ï¼Œä»¥å…å¹²å‡€çš„ç›˜å­ç”¨å®Œï¼›è€Œåœ¨ä¸å¿™çš„æ—¶å€™ï¼Œä»–ä»¬ä¼šå‡å°‘æ”¶é›†æ¬¡æ•°ï¼Œå› ä¸ºéœ€è¦æ”¶é›†çš„ç›˜å­å¾ˆå°‘ã€‚è¿™ç§æ–¹å¼ä¸ GC çš„è°ƒä¼˜æ˜¯ç›¸åŒçš„ã€‚è„ç›˜å­å°±åƒè¢«æ­»äº¡å¯¹è±¡å ç”¨çš„ç©ºé—´â€”â€”å®ƒä»¬æ›¾ç»è¢«ä½¿ç”¨è¿‡ï¼ˆå³â€œå¼„è„â€ï¼‰ï¼Œä½†ç°åœ¨å¯ä»¥è¢«å›æ”¶ã€‚å¹²å‡€çš„ç›˜å­å°±åƒ GC æ¸…ç†åæä¾›çš„ç©ºé—´ï¼Œä¾›äººä»¬ç”¨æ¥åˆ›å»ºæ–°å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯åˆ†é…å†…å­˜ã€‚å¦‚æœ GC è¿›è¡Œäº†ä¸€æ¬¡å›æ”¶ï¼Œä½†æ²¡æœ‰å‘ç°å¤ªå¤šå¯å›æ”¶çš„ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´å­˜æ´»ç‡å¾ˆé«˜ï¼Œé‚£ä¹ˆå®ƒä¼šç­‰åˆ°æ›´å¤šçš„æ¸…ç†ç©ºé—´è¢«ä½¿ç”¨ï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œåœ¨è¿›è¡Œä¸‹ä¸€æ¬¡å›æ”¶ä¹‹å‰ä¼šæœ‰æ›´å¤šçš„åˆ†é…å‘ç”Ÿã€‚

åœ¨ç”¨é¤æ—¶é—´ï¼Œç¾é£Ÿå¹¿åœºå¾ˆå¿™ï¼Œæ‰€ä»¥å¹²å‡€çš„ç›˜å­æ¶ˆè€—å¾—æ›´å¿«ï¼Œæ¸…æ´å·¥ä¹Ÿä¼šæ ¹æ®è¿™ç§æƒ…å†µè°ƒæ•´é¢‘ç‡ã€‚è¿™ä¸ GC è°ƒæ•´ä¸¤æ¬¡å›æ”¶ä¹‹é—´çš„åˆ†é…é‡æ˜¯ä¸€æ ·çš„ã€‚è¿™ä¸ªåˆ†é…é‡è¢«ç§°ä¸ºâ€œåˆ†é…é¢„ç®—â€ã€‚è€Œè¿™ç§ GC æ‰€åšçš„â€œè°ƒæ•´â€æ˜¯å…¶åŠ¨æ€è°ƒä¼˜çš„ä¸€éƒ¨åˆ†ã€‚éšç€è¿›ç¨‹è¿è¡Œï¼ŒGC ä¼šæ ¹æ®å®ƒè§‚å¯Ÿåˆ°çš„å­˜æ´»ç‡ä¿®æ”¹è¿™ä¸ªåˆ†é…é¢„ç®—ï¼Œä»¥ä¿æŒè‡ªèº«çš„é«˜æ•ˆè¿ä½œã€‚

ç°åœ¨ï¼Œæ¸…æ´å·¥éœ€è¦ä¸€ç§æ–¹æ³•æ¥è¯†åˆ«æŸä¸ªç›˜å­æ˜¯å¦ä»åœ¨ä½¿ç”¨ä¸­â€”â€”å¦‚æœæ¸…æ´å·¥åœ¨ä½ è¿˜åœ¨ä½¿ç”¨ç›˜å­æ—¶å°±æŠŠå®ƒæ‹¿èµ°ï¼Œé‚£å°†æ˜¯ç›¸å½“ä¸ç¤¼è²Œçš„ï¼ˆå¦‚æœä»–ä»¬ç»å¸¸è¿™æ ·åšï¼Œæˆ‘æƒ³ä»–ä»¬ä¼šå¤±ä¸šâ€¦â€¦ï¼‰ã€‚å¦‚æœä½ è¿˜åœ¨åƒä¸œè¥¿ï¼Œè¿™æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚è¿™æ˜¯æœ€å¸¸è§çš„åœºæ™¯ã€‚å¦‚æœè¯´ä½ éœ€è¦æš‚æ—¶ç¦»å¼€ï¼ˆæ¯”å¦‚çªç„¶è®°èµ·è¦åœ¨ç”œå“åº—å…³é—¨ä¹‹å‰ä¹°ä¸€å—è›‹ç³•ï¼‰ï¼Œä½ å¯èƒ½ä¼šæŠŠå¤–å¥—æ”¾åœ¨æ¤…å­ä¸Šï¼Œä»¥è¡¨æ˜ä½ è¿˜åœ¨é‚£é‡Œã€‚GC ä¹Ÿéœ€è¦çŸ¥é“æŸä¸ªå¯¹è±¡æ˜¯å¦ä»åœ¨ä½¿ç”¨ä¸­ã€‚æœ€å¸¸è§çš„æ–¹æ³•æ˜¯ä¸€ä¸ªå¯¹è±¡å¼•ç”¨äº†å¦ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™å¯¹ GC æ¥è¯´æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰ä¸€äº›ä¸å¤ªå¸¸è§çš„æ–¹å¼éœ€è¦é¢å¤–çš„åŠªåŠ›æ¥å‘Šè¯‰ GC æŸä¸ªå¯¹è±¡æ­£åœ¨è¢«ä½¿ç”¨ï¼Œä¾‹å¦‚ GC å¥æŸ„ã€‚

å¤šå¹´æ¥ï¼Œæˆ‘ä¸€ç›´ç”¨ç¾é£Ÿå¹¿åœºçš„æ¯”å–»æ¥å‘åˆ«äººè§£é‡Š GC çš„è°ƒä¼˜è¿‡ç¨‹ï¼Œä¼¼ä¹å¤§å®¶éƒ½å¾ˆæ¥å—è¿™ä¸ªæ¯”å–»ï¼Œç”šè‡³åŒ…æ‹¬é‚£äº›å®Œå…¨ä¸åœ¨æŠ€æœ¯é¢†åŸŸå·¥ä½œçš„äººã€‚æœ‰ä¸€æ¬¡ï¼Œæˆ‘å‚åŠ äº†ä¸€ä¸ªå…³äºæ²Ÿé€šæŠ€å·§çš„è¯¾ç¨‹ï¼Œæ¯ä¸ªäººéƒ½è¢«è¦æ±‚åšä¸€ä¸ªä¸€åˆ†é’Ÿçš„æ¼”è®²æ¥è§£é‡Šè‡ªå·±çš„å·¥ä½œã€‚ç­ä¸Šçš„è®¸å¤šäººä»äº‹é‡‘èå’Œé”€å”®è¡Œä¸šã€‚æˆ‘ç”¨äº†ç¾é£Ÿå¹¿åœºçš„æ¯”å–»ï¼Œå¤šå¹´åï¼Œè¿˜æœ‰äººçƒ­æƒ…åœ°å‘Šè¯‰æˆ‘ï¼Œä»–ä»¬é€šè¿‡è¿™ä¸ªæ¯”å–»ç†è§£äº†åƒåœ¾å›æ”¶å™¨çš„å·¥ä½œåŸç† ğŸ˜„ï¼Œå¹¶ä¸”è‡³ä»Šè¿˜è®°å¾—ã€‚

æˆ‘ä»¬çš„è¿è¡Œæ—¶å›¢é˜Ÿæ›¾ç»æœ‰ä¸€ä¸ªå«åšâ€œCLR åŸºç¡€çŸ¥è¯†â€ç³»åˆ—çš„æ´»åŠ¨ï¼Œå…¶ä¸­æŸä¸ªäººä¼šå‘å›¢é˜Ÿå…¶ä»–æˆå‘˜è§£é‡Šä»–ä»¬æ‰€è´Ÿè´£çš„é¢†åŸŸã€‚å› æ­¤ï¼Œå½“æˆ‘åœ¨è§£é‡Š GC æ—¶ï¼Œæˆ‘ä½¿ç”¨äº†ç¾é£Ÿå¹¿åœºçš„æ¯”å–»ã€‚ä¸€äº›åŒäº‹å‘Šè¯‰æˆ‘ä»–ä»¬éå¸¸å–œæ¬¢è¿™ä¸ªæ¯”å–»ã€‚å½“ç„¶ï¼Œä»–ä»¬ä¹Ÿå¾ˆæœ‰åˆ›æ„ï¼Œå¼€å§‹å»ºè®®ç”¨ç¾é£Ÿå¹¿åœºçš„å…¶ä»–äº‹ç‰©æ¥ç±»æ¯”ã€‚æˆ‘è®°å¾—æœ‰äººå»ºè®®å¯ä»¥ç”¨äººä»¬å¦‚ä½•å°±åº§æ¥è¯´æ˜å‹ç¼©å¼æ”¶é›†å™¨çš„å·¥ä½œåŸç†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœäººæ•°ä¸å¤šï¼Œä»–ä»¬å¯èƒ½ä¼šåˆ†æ•£ååœ¨ä¸åŒçš„æ¡Œå­ä¸Šã€‚ä½†å¦‚æœæ¡Œå­å¿«ä¸å¤Ÿç”¨äº†ï¼Œäººä»¬å¯ä»¥åå¾—æ›´ç´§å¯†ï¼Œä»è€Œè…¾å‡ºç©ºé—´å®¹çº³æ›´å¤šçš„äººã€‚

ä¸€æ®µæ—¶é—´å‰ï¼Œæˆ‘ä»¬å…¬å¸é£Ÿå ‚ï¼ˆåœ¨æˆ‘æ‰€åœ¨çš„é‚£æ ‹æ¥¼é‡Œï¼‰å¼€å§‹å®æ–½ä¸€é¡¹æ–°çš„â€œé›¶æµªè´¹â€æ”¿ç­–ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸å†è‡ªå·±æ‰”åƒåœ¾æˆ–æ”¶æ‹¾è„ç›˜å­ã€‚ç›¸åï¼Œç”±ä¸€åé£Ÿå ‚å‘˜å·¥æ‹…ä»»â€œåƒåœ¾æ”¶é›†å‘˜â€ã€‚è¿™å°±åƒæ˜¯åœ¨ç¾é£Ÿå¹¿åœºä¸€æ ·ã€‚è€Œä¸”è¿™ä½åƒåœ¾æ”¶é›†å‘˜çš„æ”¶é›†ç­–ç•¥éå¸¸æ¿€è¿›ã€‚æœ‰æ—¶å€™ï¼Œäººä»¬åˆšåˆšåƒå®Œé¥­è¿˜åœ¨èŠå¤©æ—¶ï¼Œä»–ä»¬å°±å·²ç»å¼€å§‹æ”¶é›†ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªäººéƒ½éœ€è¦æŠŠè‡ªå·±çš„è„ç›˜å­é€’ç»™ä»–ä»¬ ğŸ˜›ã€‚çŸ¥é“è¿™ä¸€ç‚¹åï¼Œæˆ‘å¯¹é£Ÿç‰©ç‰¹åˆ«å°å¿ƒï¼Œä½†æœ‰ä¸€æ¬¡æˆ‘è¿˜æ˜¯ä¸å¤Ÿå¿«â€”â€”æˆ‘æŠŠé£Ÿç‰©æ”¾ä¸‹æ‰å‡ ç§’é’Ÿï¼Œä»–ä»¬å°±å¼€å§‹æ”¶é›†äº†ã€‚äºæ˜¯ï¼Œæˆ‘ç»™é£Ÿå ‚ç»ç†å‘äº†ä¸€å°ç”µå­é‚®ä»¶ï¼Œå»ºè®®ä¸€ç§æ ‡è®°â€œæ­£åœ¨ä½¿ç”¨â€çš„æ–¹å¼ã€‚å¥¹ä¸€å¦‚æ—¢å¾€åœ°éå¸¸å‹å–„ï¼Œå¹¶ä¸”æ˜¾ç„¶å·²ç»æœ‰ä¸€ç§æ–¹æ³•æ¥æ ‡è®°è¿™ä¸€ç‚¹ï¼Œåªæ˜¯éœ€è¦æé†’å¥¹çš„éƒ¨åˆ†å‘˜å·¥ã€‚å¥¹è¿˜è¯´ï¼šâ€œæˆ‘ä¹Ÿä¼šç¡®ä¿ä»–ä»¬åœ¨åˆé¤é«˜å³°åçš„æ¸…æ¡Œå·¥ä½œä¸­æ˜ç™½ç­‰å¾…çš„é‡è¦æ€§ã€‚â€ æˆ‘å½“æ—¶å°±æƒ³ï¼šâ€œå˜¿ï¼Œè¿™å°±æ˜¯åŠ¨æ€è°ƒä¼˜å•Šï¼â€